---
description: Multi-tenant and e-commerce security patterns
alwaysApply: true
---

# Multi-tenant & security

- **Tenant isolation:** Every business query must be scoped by `tenant_id` (from `getTenantFromHeaders()` or route/body). Never expose data across tenants.
- **Storefront:** Tenant is resolved in middleware by host (subdomain or `tenant_domains`). Use `getTenantFromHeaders()` in Server Components and Route Handlers.
- **Webhooks:** Always verify provider signature, then use idempotency (`ensureEventStored` / `isProcessed` / `markProcessed` from `@/lib/webhooks/idempotency`). Enqueue heavy work; return 200 quickly.
- **Money:** Amounts are stored in **cents** (integer). Use `@/lib/money` for display and Stripe.
- **Fulfillment:** Use the adapter interface in `@/lib/integrations/fulfillment`; do not hardcode a single provider in order flow.
